{% extends "base.html" %}

{% block title %}Replay Attack Protection | CryptexQ{% endblock %}

{% block extra_css %}
<style>
/* Page-specific styles for Replay Protection page */
.replay-hero{
  margin-top: 3.5rem;
  text-align: center;
  padding: 2rem 0;
}

.replay-hero h1{
  font-size: 2.8rem;
  background: linear-gradient(90deg, #3B82F6, #06b6d4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 1rem;
}

.replay-hero p{
  max-width: 700px;
  margin: 0 auto;
  color: var(--text-muted);
  font-size: 1.1rem;
}

.panel{
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 2.5rem;
  margin: 2rem 0;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.panel h2{
  color: var(--accent-blue);
  margin-bottom: 1.5rem;
  font-size: 1.8rem;
}

.panel p{
  color: var(--text-secondary);
  line-height: 1.8;
  margin-bottom: 1rem;
}

.controls{
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin: 1.5rem 0;
}

.controls button{
  flex: 1;
  min-width: 200px;
  background: var(--accent-blue);
  color: white;
  padding: 1rem 2rem;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s;
}

.controls button:hover{
  background: var(--accent-cyan);
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
}

.controls button:last-child{
  background: #EF4444;
}

.controls button:last-child:hover{
  background: #DC2626;
  box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
}

.checkbox-group{
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem;
  background: rgba(59, 130, 246, 0.1);
  border-radius: 10px;
  margin: 1rem 0;
}

.checkbox-group input[type="checkbox"]{
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.checkbox-group label{
  color: var(--text-secondary);
  font-weight: 600;
  cursor: pointer;
}

.code{
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.5rem;
  font-family: 'Courier New', monospace;
  color: var(--text-primary);
  white-space: pre-wrap;
  margin: 1rem 0;
  line-height: 1.6;
}

.code.success{
  background: rgba(16, 185, 129, 0.1);
  border-color: var(--accent-green);
  color: var(--accent-green);
}

.code.error{
  background: rgba(239, 68, 68, 0.1);
  border-color: #EF4444;
  color: #EF4444;
}

.status-badge{
  display: inline-block;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.9rem;
  margin-top: 1rem;
}

.status-badge.active{
  background: rgba(16, 185, 129, 0.2);
  color: var(--accent-green);
  border: 1px solid var(--accent-green);
}

footer{
  margin-top: 4rem;
  text-align: center;
  color: var(--text-muted);
  font-size: 0.9rem;
  padding: 2rem 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <section class="replay-hero fade-in">
    <h1>üõ°Ô∏è Replay Attack Protection</h1>
    <p>
      Test how CryptexQ detects and prevents malicious message replay attacks
      using timestamp validation and nonce uniqueness checks.
    </p>
  </section>

  <div class="panel fade-in">
    <h2>Interactive Demo</h2>
    <p>
      Try sending a message, then replaying it. CryptexQ will reject packets
      with reused nonces or expired timestamps.
    </p>

    <div class="controls">
      <button onclick="sendMessage()">üì§ Send New Message</button>
      <button onclick="replayMessage()">üîÑ Replay Last Message</button>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="attackerMode">
      <label for="attackerMode">üïµÔ∏è Simulate Attacker (6s delay)</label>
    </div>

    <h3 style="color: var(--accent-blue); margin-top: 2rem;">Packet Log:</h3>
    <div class="code" id="log">No messages yet...</div>

    <h3 style="color: var(--accent-blue); margin-top: 2rem;">Analysis:</h3>
    <div class="code" id="analysis">Waiting for packet...</div>

    <div class="status-badge active">
      üîí Protection ACTIVE (timestamp + nonce enforced)
    </div>
  </div>

  <div class="panel fade-in">
    <h2>How It Works</h2>
    <div class="code">
Message + Timestamp + Nonce
‚Üì
Receiver validates:
‚Ä¢ Timestamp window
‚Ä¢ Nonce uniqueness
‚Üì
Accept or Reject
    </div>
    <p style="margin-top:1rem;">
      CryptexQ applies this protection to every encrypted message,
      ensuring replay resistance alongside authenticated encryption.
    </p>
  </div>

  <footer>
    <p>¬© 2026 CryptexQ ‚Äî Quantum-Safe Messaging Platform</p>
  </footer>
</div>
{% endblock %}

{% block extra_js %}
<script>
let lastPacket = null;
const usedNonces = new Set();
const ALLOWED_WINDOW = 5000;

function sendMessage(){
  lastPacket = {
    message: "Hello CryptexQ",
    timestamp: Date.now(),
    nonce: Math.floor(Math.random() * 1e9)
  };
  processPacket(lastPacket);
}

function replayMessage(){
  if(!lastPacket) return;
  const attacker = document.getElementById("attackerMode").checked;
  if(attacker){
    setTimeout(() => processPacket(lastPacket), 6000);
  }else{
    processPacket(lastPacket);
  }
}

function processPacket(packet){
  const age = Date.now() - packet.timestamp;
  const log = document.getElementById("log");
  const analysis = document.getElementById("analysis");

  if(usedNonces.has(packet.nonce)){
    log.textContent = "Replay detected ‚ùå";
    log.className = "code error";
    analysis.textContent = `Nonce reused ‚ùå\nAge: ${age} ms\nVerdict: REJECTED`;
    return;
  }

  if(age > ALLOWED_WINDOW){
    log.textContent = "Message expired ‚ùå";
    log.className = "code error";
    analysis.textContent = `Nonce new ‚úî\nAge: ${age} ms ‚ùå\nVerdict: REJECTED`;
    return;
  }

  usedNonces.add(packet.nonce);
  log.textContent = "Message accepted ‚úî";
  log.className = "code success";
  analysis.textContent = `Nonce new ‚úî\nAge: ${age} ms ‚úî\nVerdict: ACCEPTED`;
}
</script>
{% endblock %}
